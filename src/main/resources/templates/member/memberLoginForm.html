<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<!-- 사용자 CSS 추가 -->
<th:block layout:fragment="css">
    <link rel="stylesheet" href="/css/memberform.css">
</th:block>

<div class="container mt-5" layout:fragment="content">

    <form role="form" method="post" action="/login">
        <div class="form-group mb-3">
            <label th:for="name">아이디</label>
            <input type="name" name="name" class="form-control" placeholder="아이디를 입력해주세요">
        </div>
        <div class="form-group mb-3">
            <label th:for="password">비밀번호</label>
            <input type="password" name="password" id="password" class="form-control" placeholder="비밀번호 입력">
        </div>
        <p th:if="${loginErrorMsg}" class="error" th:text="${loginErrorMsg}"></p>
        <button class="btn btn-success">로그인</button>
        <button type="button" class="btn btn-primary" onClick="location.href='/signup'">회원가입</button>
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
    </form>

    <!-- 비밀번호 찾기 폼 -->
    <div class="mt-5">
        <h4>비밀번호를 잊으셨나요?</h4>
        <form id="passwordResetForm" method="post" action="/send/password">
            <div class="form-group mb-3">
                <label for="email">이메일</label>
                <input type="email" id="email" name="email" class="form-control" placeholder="이메일을 입력해주세요" required>
            </div>
            <button type="submit" class="btn btn-warning">임시 비밀번호 요청</button>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </form>
        <p id="passwordResetMessage" class="text-success mt-3" style="display:none;"></p>
        <p id="errorMessage" class="text-danger mt-3" style="display:none;"></p>
    </div>

    <!-- 아이디 찾기 폼 -->
    <div class="mt-5">
        <h4>아이디를 잊으셨나요?</h4>
        <form id="idFindForm" method="post" action="/find/id">
            <div class="form-group mb-3">
                <label for="email">이메일</label>
                <input type="email" id="findEmail" name="email" class="form-control" placeholder="이메일을 입력해주세요" required>
            </div>
            <button type="submit" class="btn btn-primary">아이디 찾기</button>
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        </form>
        <p id="idFindMessage" class="text-success mt-3" style="display:none;"></p>
        <p id="idErrorMessage" class="text-danger mt-3" style="display:none;"></p>
    </div>

    <div class="login_api mt-5">
        <p class="text-center pt-3">간편하게 가입하고 상품을 확인하세요</p>
        <ul>
            <li class="google_login text-center">
                <a href="/oauth2/authorization/google">
                    <img src="/img/web_neutral_rd_na@2x.png" alt="구글로그인">
                </a>
            </li>
            <li class="naver_login text-center">
                <a href="/oauth2/authorization/naver">
                    <img src="/img/naver_login.png" alt="네이버로그인">
                </a>
            </li>
            <li class="kakao_login text-center">
                <a href="/oauth2/authorization/kakao">
                    <img src="/img/kakao_login_icon.png" alt="카카오로그인">
                </a>
            </li>
        </ul>
    </div>

</div>

<!-- JavaScript 코드로 폼 제출 후 응답 처리 -->
<script>
    document.getElementById('passwordResetForm').addEventListener('submit', function(event) {
        event.preventDefault();
        var email = document.getElementById('email').value;
        var formData = new FormData();
        formData.append('email', email);

        fetch('/send/password', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.message === '비밀번호 발급이 완료되었습니다.') {
                    document.getElementById('passwordResetMessage').textContent = data.message;
                    document.getElementById('passwordResetMessage').style.display = 'block';
                    document.getElementById('errorMessage').style.display = 'none';
                } else {
                    document.getElementById('errorMessage').textContent = data.message;
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('passwordResetMessage').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('errorMessage').textContent = '서버와의 통신에 실패했습니다.';
                document.getElementById('errorMessage').style.display = 'block';
            });
    });

    // 아이디 찾기 폼 제출 처리
    document.getElementById('idFindForm').addEventListener('submit', function(event) {
        event.preventDefault();
        var email = document.getElementById('findEmail').value;
        var formData = new FormData();
        formData.append('email', email);

        fetch('/find/id', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.message.includes("아이디:")) {
                    document.getElementById('idFindMessage').textContent = data.message;
                    document.getElementById('idFindMessage').style.display = 'block';
                    document.getElementById('idErrorMessage').style.display = 'none';
                } else {
                    document.getElementById('idErrorMessage').textContent = data.message;
                    document.getElementById('idErrorMessage').style.display = 'block';
                    document.getElementById('idFindMessage').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('idErrorMessage').textContent = '서버와의 통신에 실패했습니다.';
                document.getElementById('idErrorMessage').style.display = 'block';
            });
    });
</script>

</html>
